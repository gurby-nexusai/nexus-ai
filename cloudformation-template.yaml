AWSTemplateFormatVersion: '2010-09-09'
Description: 'Nexus AI - Enterprise AI Application Suite - 20 AI Applications'

Parameters:
  InstanceType:
    Description: EC2 instance type for frontend server
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.small
      - t3.medium
      - t3.large
    ConstraintDescription: Must be a valid EC2 instance type

  BackendInstanceType:
    Description: EC2 instance type for backend API server
    Type: String
    Default: t3.small
    AllowedValues:
      - t3.small
      - t3.medium
    ConstraintDescription: Must be a valid EC2 instance type

  KeyName:
    Description: EC2 Key Pair for SSH access
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair

  LLMProvider:
    Description: Choose your LLM provider
    Type: String
    Default: Ollama
    AllowedValues:
      - Ollama
      - Groq
      - AmazonNova
      - OpenRouter
    ConstraintDescription: Select LLM provider

  SSHLocation:
    Description: IP address range that can SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: Must be a valid IP CIDR range

Resources:
  # VPC Configuration
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: NexusAI-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: NexusAI-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: NexusAI-PublicSubnet1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: NexusAI-PublicSubnet2

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: NexusAI-PublicRouteTable

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  SubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Security Groups
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: NexusAI-ALB-SG

  FrontendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for frontend server
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5174
          ToPort: 5174
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
      Tags:
        - Key: Name
          Value: NexusAI-Frontend-SG

  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for backend API server
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5002
          ToPort: 5002
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
      Tags:
        - Key: Name
          Value: NexusAI-Backend-SG

  # IAM Role for EC2 instances
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: NexusAI-EC2-Role

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Frontend EC2 Instance
  FrontendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: '0'
          GroupSet:
            - !Ref FrontendSecurityGroup
          SubnetId: !Ref PublicSubnet1
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          
          # Update system
          yum update -y
          
          # Install Node.js 18
          curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
          yum install -y nodejs git
          
          # Install Ollama if selected
          if [ "${LLMProvider}" = "Ollama" ]; then
            curl -fsSL https://ollama.com/install.sh | sh
            systemctl enable ollama
            systemctl start ollama
            sleep 5
            ollama pull llama3.1
          fi
          
          # Clone and setup application
          cd /home/ec2-user
          git clone https://github.com/YOUR_REPO/nexus-ai.git
          cd nexus-ai/frontend/airoi-ui/my-app
          
          # Install dependencies
          npm install
          
          # Create systemd service
          cat > /etc/systemd/system/nexus-frontend.service <<EOF
          [Unit]
          Description=Nexus AI Frontend
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=/home/ec2-user/nexus-ai/frontend/airoi-ui/my-app
          ExecStart=/usr/bin/npm run dev
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Start service
          systemctl daemon-reload
          systemctl enable nexus-frontend
          systemctl start nexus-frontend
          
          # Signal completion
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource FrontendInstance --region ${AWS::Region}
      Tags:
        - Key: Name
          Value: NexusAI-Frontend
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M

  # Backend EC2 Instance
  BackendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref BackendInstanceType
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: '0'
          GroupSet:
            - !Ref BackendSecurityGroup
          SubnetId: !Ref PublicSubnet1
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          
          # Update system
          yum update -y
          
          # Install Python 3.11
          yum install -y python3.11 python3.11-pip git
          
          # Clone and setup application
          cd /home/ec2-user
          git clone https://github.com/YOUR_REPO/nexus-ai.git
          cd nexus-ai/backend
          
          # Create virtual environment
          python3.11 -m venv venv
          source venv/bin/activate
          
          # Install dependencies
          pip install flask flask-cors pandas numpy scikit-learn scipy
          
          # Create systemd service
          cat > /etc/systemd/system/nexus-backend.service <<EOF
          [Unit]
          Description=Nexus AI Backend API
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=/home/ec2-user/nexus-ai/backend
          ExecStart=/home/ec2-user/nexus-ai/backend/venv/bin/python api_server.py
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Start service
          systemctl daemon-reload
          systemctl enable nexus-backend
          systemctl start nexus-backend
          
          # Signal completion
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource BackendInstance --region ${AWS::Region}
      Tags:
        - Key: Name
          Value: NexusAI-Backend
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: NexusAI-ALB
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Tags:
        - Key: Name
          Value: NexusAI-ALB

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: NexusAI-TG
      Port: 5174
      Protocol: HTTP
      VpcId: !Ref VPC
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Targets:
        - Id: !Ref FrontendInstance
          Port: 5174

  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

Outputs:
  ApplicationURL:
    Description: URL to access Nexus AI application
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-URL'

  FrontendInstanceId:
    Description: Frontend EC2 Instance ID
    Value: !Ref FrontendInstance

  BackendInstanceId:
    Description: Backend EC2 Instance ID
    Value: !Ref BackendInstance

  LoadBalancerDNS:
    Description: Load Balancer DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  DefaultLoginCredentials:
    Description: Default login credentials
    Value: 'Email: admin@example.com | Password: any password'

  SupportContact:
    Description: Support contact
    Value: 'gurby1@yahoo.com'
